// ==UserScript==
// @name        GIF Controls
// @namespace   https://github.com/HimbeersaftLP/libgif-js/
// @match       *://*/*
// @version     0.0.1
// @description Adds GIF controls to websites
// @run-at      document-idle
// @grant       GM_registerMenuCommand
// @homepageURL https://github.com/HimbeersaftLP/libgif-js/
// ==/UserScript==
!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){var r,i,o;i=[],void 0===(o="function"==typeof(r=function(){var e=function(e){return e.reduce((function(e,t){return 2*e+t}),0)},t=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},n=function(e){this.data=e,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[this.pos++]:255&e.charCodeAt(this.pos++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},r=function(n,r){r||(r={});var i=function(e){for(var t=[],r=0;r<e;r++)t.push(n.readBytes(3));return t},o=function(){var e,t;t="";do{e=n.readByte(),t+=n.read(e)}while(0!==e);return t},a=function(a){a.leftPos=n.readUnsigned(),a.topPos=n.readUnsigned(),a.width=n.readUnsigned(),a.height=n.readUnsigned();var l=t(n.readByte());a.lctFlag=l.shift(),a.interlaced=l.shift(),a.sorted=l.shift(),a.reserved=l.splice(0,2),a.lctSize=e(l.splice(0,3)),a.lctFlag&&(a.lct=i(1<<a.lctSize+1)),a.lzwMinCodeSize=n.readByte();var u=o();a.pixels=function(e,t){for(var n,r,i=0,o=function(e){for(var n=0,r=0;r<e;r++)t.charCodeAt(i>>3)&1<<(7&i)&&(n|=1<<r),i++;return n},a=[],l=1<<e,u=l+1,c=e+1,s=[],d=function(){s=[],c=e+1;for(var t=0;t<l;t++)s[t]=[t];s[l]=[],s[u]=null};;)if(r=n,(n=o(c))!==l){if(n===u)break;if(n<s.length)r!==l&&s.push(s[r].concat(s[n][0]));else{if(n!==s.length)throw new Error("Invalid LZW code.");s.push(s[r].concat(s[r][0]))}a.push.apply(a,s[n]),s.length===1<<c&&c<12&&c++}else d();return a}(a.lzwMinCodeSize,u),a.interlaced&&(a.pixels=function(e,t){for(var n=new Array(e.length),r=e.length/t,i=function(r,i){var o=e.slice(i*t,(i+1)*t);n.splice.apply(n,[r*t,t].concat(o))},o=[0,4,2,1],a=[8,8,4,2],l=0,u=0;u<4;u++)for(var c=o[u];c<r;c+=a[u])i(c,l),l++;return n}(a.pixels,a.width)),r.img&&r.img(a)},l=function(){var i={};switch(i.sentinel=n.readByte(),String.fromCharCode(i.sentinel)){case"!":i.type="ext",function(i){switch(i.label=n.readByte(),i.label){case 249:i.extType="gce",function(i){n.readByte();var o=t(n.readByte());i.reserved=o.splice(0,3),i.disposalMethod=e(o.splice(0,3)),i.userInput=o.shift(),i.transparencyGiven=o.shift(),i.delayTime=n.readUnsigned(),i.transparencyIndex=n.readByte(),i.terminator=n.readByte(),r.gce&&r.gce(i)}(i);break;case 254:i.extType="com",function(e){e.comment=o(),r.com&&r.com(e)}(i);break;case 1:i.extType="pte",function(e){n.readByte(),e.ptHeader=n.readBytes(12),e.ptData=o(),r.pte&&r.pte(e)}(i);break;case 255:i.extType="app",function(e){switch(n.readByte(),e.identifier=n.read(8),e.authCode=n.read(3),e.identifier){case"NETSCAPE":!function(e){n.readByte(),e.unknown=n.readByte(),e.iterations=n.readUnsigned(),e.terminator=n.readByte(),r.app&&r.app.NETSCAPE&&r.app.NETSCAPE(e)}(e);break;default:!function(e){e.appData=o(),r.app&&r.app[e.identifier]&&r.app[e.identifier](e)}(e)}}(i);break;default:i.extType="unknown",function(e){e.data=o(),r.unknown&&r.unknown(e)}(i)}}(i);break;case",":i.type="img",a(i);break;case";":i.type="eof",r.eof&&r.eof(i);break;default:throw new Error("Unknown block: 0x"+i.sentinel.toString(16))}"eof"!==i.type&&setTimeout(l,0)};!function(){var o={};if(o.sig=n.read(3),o.ver=n.read(3),"GIF"!==o.sig)throw new Error("Not a GIF file.");o.width=n.readUnsigned(),o.height=n.readUnsigned();var a=t(n.readByte());o.gctFlag=a.shift(),o.colorRes=e(a.splice(0,3)),o.sorted=a.shift(),o.gctSize=e(a.splice(0,3)),o.bgColor=n.readByte(),o.pixelAspectRatio=n.readByte(),o.gctFlag&&(o.gct=i(1<<o.gctSize+1)),r.hdr&&r.hdr(o)}(),setTimeout(l,0)};return function(e){var t,i,o={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var a in e)o[a]=e[a];o.vp_w&&o.vp_h&&(o.is_vp=!0);var l,u=null,c=!1,s=null,d=null,h=null,p=null,f=null,g=null,y=null,_=!0,w=!1,v=[],m=[],b=1,x=o.gif;void 0===o.auto_play&&(o.auto_play=!x.getAttribute("rel:auto_play")||"1"==x.getAttribute("rel:auto_play"));var T,B,P,C,S=o.hasOwnProperty("on_end")?o.on_end:null,k=o.hasOwnProperty("loop_delay")?o.loop_delay:0,A=o.hasOwnProperty("loop_mode")?o.loop_mode:"auto",E=!o.hasOwnProperty("draw_while_loading")||o.draw_while_loading,O=!!E&&(!o.hasOwnProperty("show_progress_bar")||o.show_progress_bar),I=o.hasOwnProperty("progressbar_height")?o.progressbar_height:25,U=o.hasOwnProperty("progressbar_background_color")?o.progressbar_background_color:"rgba(255,255,255,0.4)",M=o.hasOwnProperty("progressbar_foreground_color")?o.progressbar_foreground_color:"rgba(255,0,22,.8)",j=function(){s=null,d=null,f=h,h=null,g=null},R=function(){try{r(t,L)}catch(e){D("parse")}},z=function(e,t){T.width=e*X(),T.height=t*X(),P.style.minWidth=e*X()+"px",C.width=e,C.height=t,C.style.width=e+"px",C.style.height=t+"px",C.getContext("2d").setTransform(1,0,0,1,0,0)},N=function(e,t,n){if(n&&O){var r,i,a,l=I;o.is_vp?w?(i=(o.vp_t+o.vp_h-l)/X(),l/=X(),r=o.vp_l/X()+e/t*(o.vp_w/X()),a=T.width/X()):(i=o.vp_t+o.vp_h-l,l=l,r=o.vp_l+e/t*o.vp_w,a=T.width):(i=(T.height-l)/(w?X():1),r=e/t*T.width/(w?X():1),a=T.width/(w?X():1),l/=w?X():1),B.fillStyle=U,B.fillRect(r,i,a-r,l),B.fillStyle=M,B.fillRect(0,i,r,l)}},D=function(e){u=e,i={width:x.width,height:x.height},v=[],B.fillStyle="black",B.fillRect(0,0,o.c_w?o.c_w:i.width,o.c_h?o.c_h:i.height),B.strokeStyle="red",B.lineWidth=3,B.moveTo(0,0),B.lineTo(o.c_w?o.c_w:i.width,o.c_h?o.c_h:i.height),B.moveTo(0,o.c_h?o.c_h:i.height),B.lineTo(o.c_w?o.c_w:i.width,0),B.stroke()},F=function(){g&&(v.push({data:g.getImageData(0,0,i.width,i.height),delay:d}),m.push({x:0,y:0}))},G=function(){var e,t,n,r=-1,i=0,a=function(e){r+=e,s()},c=(e=!1,t=function(){null!==S&&S(x),i++,!1!==A||i<0?n():(e=!1,_=!1)},n=function(){if(e=_){a(1);var i=10*v[r].delay;i||(i=100),i*=b,0==(r+1+v.length)%v.length?(i+=k,setTimeout(t,i)):setTimeout(n,i)}},function(){e||setTimeout(n,0)}),s=function(){var e;l&&l(r),(r=parseInt(r,10))>v.length-1&&(r=0),r<0&&(r=0),e=m[r],C.getContext("2d").putImageData(v[r].data,e.x,e.y),B.globalCompositeOperation="copy",B.drawImage(C,0,0)};return{init:function(){u||(o.c_w&&o.c_h||B.scale(X(),X()),o.auto_play?c():(r=0,s()))},step:c,play:function(){_=!0,c()},pause:function(){_=!1},playing:_,move_relative:a,current_frame:function(){return r},length:function(){return v.length},move_to:function(e){r=e,s()}}}(),W=function(e){N(t.pos,t.data.length,e)},H=function(){},q=function(e,t){return function(n){e(n),W(t)}},L={hdr:q((function(e){z((i=e).width,i.height)})),gce:q((function(e){F(),j(),s=e.transparencyGiven?e.transparencyIndex:null,d=e.delayTime,h=e.disposalMethod})),com:q(H),app:{NETSCAPE:q(H)},img:q((function(e){g||(g=C.getContext("2d"));var t=v.length,n=e.lctFlag?e.lct:i.gct;t>0&&(3===f?null!==p?g.putImageData(v[p].data,0,0):g.clearRect(y.leftPos,y.topPos,y.width,y.height):p=t-1,2===f&&g.clearRect(y.leftPos,y.topPos,y.width,y.height));var r=g.getImageData(e.leftPos,e.topPos,e.width,e.height);e.pixels.forEach((function(e,t){e!==s&&(r.data[4*t+0]=n[e][0],r.data[4*t+1]=n[e][1],r.data[4*t+2]=n[e][2],r.data[4*t+3]=255)})),g.putImageData(r,e.leftPos,e.topPos),w||(B.scale(X(),X()),w=!0),E&&(B.drawImage(C,0,0),E=o.auto_play),y=e}),!0),eof:function(){F(),W(!1),o.c_w&&o.c_h||(T.width=i.width*X(),T.height=i.height*X()),G.init(),c=!1,J&&J(x)}},V=function(){var e=x.parentNode,t=document.createElement("div");T=document.createElement("canvas"),B=T.getContext("2d"),P=document.createElement("div"),C=document.createElement("canvas"),t.width=T.width=x.width,t.height=T.height=x.height,P.style.minWidth=x.width+"px",t.className="jsgif",P.className="jsgif_toolbar",t.appendChild(T),t.appendChild(P),e.insertBefore(t,x),e.removeChild(x),o.c_w&&o.c_h&&z(o.c_w,o.c_h),Z=!0},X=function(){return o.max_width&&i&&i.width>o.max_width?o.max_width/i.width:1},Z=!1,J=!1,K=function(e){return!c&&(J=e||!1,c=!0,v=[],j(),p=null,f=null,g=null,y=null,!0)};return{play:G.play,pause:G.pause,move_relative:G.move_relative,move_to:G.move_to,get_playing:function(){return _},get_canvas:function(){return T},get_canvas_scale:function(){return X()},get_loading:function(){return c},get_auto_play:function(){return o.auto_play},get_length:function(){return G.length()},get_current_frame:function(){return G.current_frame()},load_url:function(e,r){if(K(r)){var i=new XMLHttpRequest;i.open("GET",e,!0),"overrideMimeType"in i?i.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in i?i.responseType="arraybuffer":i.setRequestHeader("Accept-Charset","x-user-defined"),i.onloadstart=function(){Z||V()},i.onload=function(){200!=this.status&&D("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var e=this.response;e.toString().indexOf("ArrayBuffer")>0&&(e=new Uint8Array(e)),t=new n(e),setTimeout(R,0)},i.onprogress=function(e){e.lengthComputable&&N(e.loaded,e.total,!0)},i.onerror=function(){D("xhr")},i.send()}},load:function(e){this.load_url(x.getAttribute("rel:animated_src")||x.src,e)},load_raw:function(e,r){K(r)&&(Z||V(),t=new n(e),setTimeout(R,0))},set_frame_offset:function(e,t){m[e]?(void 0!==t.x&&(m[e].x=t.x),void 0!==t.y&&(m[e].y=t.y)):m[e]=t},set_multiplier:function(e){b=e},on_frame_change:function(e){l=e}}}})?r.apply(t,i):r)||(e.exports=o)},function(e,t,n){"use strict";n.r(t);n(0)}]);