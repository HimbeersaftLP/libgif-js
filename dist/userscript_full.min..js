// ==UserScript==
// @name        GIF Controls
// @namespace   https://github.com/HimbeersaftLP/libgif-js/
// @match       *://*/*
// @version     0.0.1
// @description Adds GIF controls to websites
// @run-at      document-idle
// @grant       GM_registerMenuCommand
// @homepageURL https://github.com/HimbeersaftLP/libgif-js/
// ==/UserScript==
!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){var r,o,a;o=[],void 0===(a="function"==typeof(r=function(){var e=function(e){return e.reduce((function(e,t){return 2*e+t}),0)},t=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},n=function(e){this.data=e,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[this.pos++]:255&e.charCodeAt(this.pos++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},r=function(n,r){r||(r={});var o=function(e){for(var t=[],r=0;r<e;r++)t.push(n.readBytes(3));return t},a=function(){var e,t;t="";do{e=n.readByte(),t+=n.read(e)}while(0!==e);return t},i=function(i){i.leftPos=n.readUnsigned(),i.topPos=n.readUnsigned(),i.width=n.readUnsigned(),i.height=n.readUnsigned();var l=t(n.readByte());i.lctFlag=l.shift(),i.interlaced=l.shift(),i.sorted=l.shift(),i.reserved=l.splice(0,2),i.lctSize=e(l.splice(0,3)),i.lctFlag&&(i.lct=o(1<<i.lctSize+1)),i.lzwMinCodeSize=n.readByte();var s=a();i.pixels=function(e,t){for(var n,r,o=0,a=function(e){for(var n=0,r=0;r<e;r++)t.charCodeAt(o>>3)&1<<(7&o)&&(n|=1<<r),o++;return n},i=[],l=1<<e,s=l+1,c=e+1,u=[],d=function(){u=[],c=e+1;for(var t=0;t<l;t++)u[t]=[t];u[l]=[],u[s]=null};;)if(r=n,(n=a(c))!==l){if(n===s)break;if(n<u.length)r!==l&&u.push(u[r].concat(u[n][0]));else{if(n!==u.length)throw new Error("Invalid LZW code.");u.push(u[r].concat(u[r][0]))}i.push.apply(i,u[n]),u.length===1<<c&&c<12&&c++}else d();return i}(i.lzwMinCodeSize,s),i.interlaced&&(i.pixels=function(e,t){for(var n=new Array(e.length),r=e.length/t,o=function(r,o){var a=e.slice(o*t,(o+1)*t);n.splice.apply(n,[r*t,t].concat(a))},a=[0,4,2,1],i=[8,8,4,2],l=0,s=0;s<4;s++)for(var c=a[s];c<r;c+=i[s])o(c,l),l++;return n}(i.pixels,i.width)),r.img&&r.img(i)},l=function(){var o={};switch(o.sentinel=n.readByte(),String.fromCharCode(o.sentinel)){case"!":o.type="ext",function(o){switch(o.label=n.readByte(),o.label){case 249:o.extType="gce",function(o){n.readByte();var a=t(n.readByte());o.reserved=a.splice(0,3),o.disposalMethod=e(a.splice(0,3)),o.userInput=a.shift(),o.transparencyGiven=a.shift(),o.delayTime=n.readUnsigned(),o.transparencyIndex=n.readByte(),o.terminator=n.readByte(),r.gce&&r.gce(o)}(o);break;case 254:o.extType="com",function(e){e.comment=a(),r.com&&r.com(e)}(o);break;case 1:o.extType="pte",function(e){n.readByte(),e.ptHeader=n.readBytes(12),e.ptData=a(),r.pte&&r.pte(e)}(o);break;case 255:o.extType="app",function(e){switch(n.readByte(),e.identifier=n.read(8),e.authCode=n.read(3),e.identifier){case"NETSCAPE":!function(e){n.readByte(),e.unknown=n.readByte(),e.iterations=n.readUnsigned(),e.terminator=n.readByte(),r.app&&r.app.NETSCAPE&&r.app.NETSCAPE(e)}(e);break;default:!function(e){e.appData=a(),r.app&&r.app[e.identifier]&&r.app[e.identifier](e)}(e)}}(o);break;default:o.extType="unknown",function(e){e.data=a(),r.unknown&&r.unknown(e)}(o)}}(o);break;case",":o.type="img",i(o);break;case";":o.type="eof",r.eof&&r.eof(o);break;default:throw new Error("Unknown block: 0x"+o.sentinel.toString(16))}"eof"!==o.type&&setTimeout(l,0)};!function(){var a={};if(a.sig=n.read(3),a.ver=n.read(3),"GIF"!==a.sig)throw new Error("Not a GIF file.");a.width=n.readUnsigned(),a.height=n.readUnsigned();var i=t(n.readByte());a.gctFlag=i.shift(),a.colorRes=e(i.splice(0,3)),a.sorted=i.shift(),a.gctSize=e(i.splice(0,3)),a.bgColor=n.readByte(),a.pixelAspectRatio=n.readByte(),a.gctFlag&&(a.gct=o(1<<a.gctSize+1)),r.hdr&&r.hdr(a)}(),setTimeout(l,0)};return function(e){var t,o,a={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var i in e)a[i]=e[i];a.vp_w&&a.vp_h&&(a.is_vp=!0);var l,s=null,c=!1,u=null,d=null,p=null,f=null,h=null,g=null,m=null,y=!0,_=!1,v=[],w=[],b=1,x=a.gif;void 0===a.auto_play&&(a.auto_play=!x.getAttribute("rel:auto_play")||"1"==x.getAttribute("rel:auto_play"));var T,E,C,k,P=a.hasOwnProperty("on_end")?a.on_end:null,B=a.hasOwnProperty("loop_delay")?a.loop_delay:0,S=a.hasOwnProperty("loop_mode")?a.loop_mode:"auto",A=!a.hasOwnProperty("draw_while_loading")||a.draw_while_loading,j=!!A&&(!a.hasOwnProperty("show_progress_bar")||a.show_progress_bar),M=a.hasOwnProperty("progressbar_height")?a.progressbar_height:25,O=a.hasOwnProperty("progressbar_background_color")?a.progressbar_background_color:"rgba(255,255,255,0.4)",I=a.hasOwnProperty("progressbar_foreground_color")?a.progressbar_foreground_color:"rgba(255,0,22,.8)",L=function(){u=null,d=null,h=p,p=null,g=null},U=function(){try{r(t,q)}catch(e){D("parse")}},N=function(e,t){T.width=e*V(),T.height=t*V(),C.style.minWidth=e*V()+"px",k.width=e,k.height=t,k.style.width=e+"px",k.style.height=t+"px",k.getContext("2d").setTransform(1,0,0,1,0,0)},R=function(e,t,n){if(n&&j){var r,o,i,l=M;a.is_vp?_?(o=(a.vp_t+a.vp_h-l)/V(),l/=V(),r=a.vp_l/V()+e/t*(a.vp_w/V()),i=T.width/V()):(o=a.vp_t+a.vp_h-l,l=l,r=a.vp_l+e/t*a.vp_w,i=T.width):(o=(T.height-l)/(_?V():1),r=e/t*T.width/(_?V():1),i=T.width/(_?V():1),l/=_?V():1),E.fillStyle=O,E.fillRect(r,o,i-r,l),E.fillStyle=I,E.fillRect(0,o,r,l)}},D=function(e){s=e,o={width:x.width,height:x.height},v=[],E.fillStyle="black",E.fillRect(0,0,a.c_w?a.c_w:o.width,a.c_h?a.c_h:o.height),E.strokeStyle="red",E.lineWidth=3,E.moveTo(0,0),E.lineTo(a.c_w?a.c_w:o.width,a.c_h?a.c_h:o.height),E.moveTo(0,a.c_h?a.c_h:o.height),E.lineTo(a.c_w?a.c_w:o.width,0),E.stroke()},z=function(){g&&(v.push({data:g.getImageData(0,0,o.width,o.height),delay:d}),w.push({x:0,y:0}))},W=function(){var e,t,n,r=-1,o=0,i=function(e){r+=e,u()},c=(e=!1,t=function(){null!==P&&P(x),o++,!1!==S||o<0?n():(e=!1,y=!1)},n=function(){if(e=y){i(1);var o=10*v[r].delay;o||(o=100),o*=b,0==(r+1+v.length)%v.length?(o+=B,setTimeout(t,o)):setTimeout(n,o)}},function(){e||setTimeout(n,0)}),u=function(){var e;l&&l(r),(r=parseInt(r,10))>v.length-1&&(r=0),r<0&&(r=0),e=w[r],k.getContext("2d").putImageData(v[r].data,e.x,e.y),E.globalCompositeOperation="copy",E.drawImage(k,0,0)};return{init:function(){s||(a.c_w&&a.c_h||E.scale(V(),V()),a.auto_play?c():(r=0,u()))},step:c,play:function(){y=!0,c()},pause:function(){y=!1},playing:y,move_relative:i,current_frame:function(){return r},length:function(){return v.length},move_to:function(e){r=e,u()}}}(),F=function(e){R(t.pos,t.data.length,e)},G=function(){},H=function(e,t){return function(n){e(n),F(t)}},q={hdr:H((function(e){N((o=e).width,o.height)})),gce:H((function(e){z(),L(),u=e.transparencyGiven?e.transparencyIndex:null,d=e.delayTime,p=e.disposalMethod})),com:H(G),app:{NETSCAPE:H(G)},img:H((function(e){g||(g=k.getContext("2d"));var t=v.length,n=e.lctFlag?e.lct:o.gct;t>0&&(3===h?null!==f?g.putImageData(v[f].data,0,0):g.clearRect(m.leftPos,m.topPos,m.width,m.height):f=t-1,2===h&&g.clearRect(m.leftPos,m.topPos,m.width,m.height));var r=g.getImageData(e.leftPos,e.topPos,e.width,e.height);e.pixels.forEach((function(e,t){e!==u&&(r.data[4*t+0]=n[e][0],r.data[4*t+1]=n[e][1],r.data[4*t+2]=n[e][2],r.data[4*t+3]=255)})),g.putImageData(r,e.leftPos,e.topPos),_||(E.scale(V(),V()),_=!0),A&&(E.drawImage(k,0,0),A=a.auto_play),m=e}),!0),eof:function(){z(),F(!1),a.c_w&&a.c_h||(T.width=o.width*V(),T.height=o.height*V()),W.init(),c=!1,$&&$(x)}},X=function(){var e=x.parentNode,t=document.createElement("div");T=document.createElement("canvas"),E=T.getContext("2d"),C=document.createElement("div"),k=document.createElement("canvas"),t.width=T.width=x.width,t.height=T.height=x.height,C.style.minWidth=x.width+"px",t.className="jsgif",C.className="jsgif_toolbar",t.appendChild(T),t.appendChild(C),e.insertBefore(t,x),e.removeChild(x),a.c_w&&a.c_h&&N(a.c_w,a.c_h),Z=!0},V=function(){return a.max_width&&o&&o.width>a.max_width?a.max_width/o.width:1},Z=!1,$=!1,J=function(e){return!c&&($=e||!1,c=!0,v=[],L(),f=null,h=null,g=null,m=null,!0)};return{play:W.play,pause:W.pause,move_relative:W.move_relative,move_to:W.move_to,get_playing:function(){return y},get_canvas:function(){return T},get_canvas_scale:function(){return V()},get_loading:function(){return c},get_auto_play:function(){return a.auto_play},get_length:function(){return W.length()},get_current_frame:function(){return W.current_frame()},load_url:function(e,r){if(J(r)){var o=new XMLHttpRequest;o.open("GET",e,!0),"overrideMimeType"in o?o.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in o?o.responseType="arraybuffer":o.setRequestHeader("Accept-Charset","x-user-defined"),o.onloadstart=function(){Z||X()},o.onload=function(){200!=this.status&&D("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var e=this.response;e.toString().indexOf("ArrayBuffer")>0&&(e=new Uint8Array(e)),t=new n(e),setTimeout(U,0)},o.onprogress=function(e){e.lengthComputable&&R(e.loaded,e.total,!0)},o.onerror=function(){D("xhr")},o.send()}},load:function(e){this.load_url(x.getAttribute("rel:animated_src")||x.src,e)},load_raw:function(e,r){J(r)&&(Z||X(),t=new n(e),setTimeout(U,0))},set_frame_offset:function(e,t){w[e]?(void 0!==t.x&&(w[e].x=t.x),void 0!==t.y&&(w[e].y=t.y)):w[e]=t},set_multiplier:function(e){b=e},on_frame_change:function(e){l=e}}}})?r.apply(t,o):r)||(e.exports=a)},function(e,t,n){"use strict";n.r(t);var r=n(0),o=n.n(r);!function(){function e(e){const t=new o.a({gif:e,auto_play:!0});t.load(()=>{const e=t.get_canvas().parentElement.querySelector(".jsgif_toolbar");e.style.setProperty("font-family","sans-serif","important"),e.style.maxWidth=e.style.minWidth,e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation()});const n=document.createElement("div");n.className="jsgif-bookmarklet-pbar",e.appendChild(n);const r=t.get_length()-1;t.on_frame_change(e=>{e===r+1&&(e=0);const t=Math.round(e/r*100)+"%";n.innerText=e+"/"+r+" ("+t+")",n.style.setProperty("background-image","linear-gradient(90deg, gray "+t+", #eee "+t+", #eee 100%)","important")});let o=!1;function a(e){const o=n.getBoundingClientRect(),a=e.clientX-o.x,i=Math.round(a/o.width*r);t.move_to(i)}n.addEventListener("mousedown",e=>{o=!0,a(e)}),n.addEventListener("mousemove",e=>{o&&a(e)}),window.addEventListener("mouseup",()=>o=!1);const i=document.createElement("div");function l(e,t){const n=document.createElement("button");return n.className="jsgif-bookmarklet-btn",n.innerText=e,n.addEventListener("click",t),i.appendChild(n),n}e.appendChild(i),l("⏸",e=>{t.get_playing()?(e.target.innerHTML="▶",t.pause()):(e.target.innerHTML="⏸",t.play())}),l("⬅",()=>{t.get_current_frame()<=0?t.move_to(r):t.move_relative(-1)}),l("➡",()=>{t.get_current_frame()>=r?t.move_to(0):t.move_relative(1)}),l("⏹",()=>{t.pause(),t.move_to(0)});const s=document.createElement("select");[.25,.5,1,1.5,2].forEach(e=>{const t=document.createElement("option");t.innerText="x"+e,t.value=e,1===e&&(t.selected=!0),s.appendChild(t)}),s.addEventListener("input",()=>{t.set_multiplier(1/s.value)}),i.appendChild(s)})}GM_registerMenuCommand("Add Controls",(function(){const t=document.querySelectorAll('img[src$=".gif"]');if(t.length>0){Array.from(t).forEach(t=>{if(null!==t.getAttribute("data-jsgif-listeneradded"))return;let n;t.setAttribute("data-jsgif-listeneradded",""),t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),t.complete&&void 0!==t.naturalWidth&&0!==t.naturalWidth?e(t):t.onload=()=>e(t)}),t.addEventListener("mouseover",()=>{n=t.style.filter,t.style.filter=n+"brightness(0.3)"}),t.addEventListener("mouseout",()=>t.style.filter=n)});const n=document.createElement("style");n.innerText='.jsgif-bookmarklet-pbar{color:#000!important;background-color:#eee!important;text-decoration:none!important;cursor:default!important;user-select:none!important;text-align:center!important;}.jsgif-bookmarklet-btn{font-family:"Segoe UI Symbol", sans-serif!important;height:30px!important;width:30px!important;}',document.head.appendChild(n)}}))}()}]);