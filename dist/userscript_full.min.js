// ==UserScript==
// @name        GIF Controls
// @namespace   https://github.com/HimbeersaftLP/libgif-js/
// @match       *://*/*
// @version     0.0.1
// @description Adds GIF controls to websites
// @run-at      document-idle
// @grant       GM_registerMenuCommand
// @grant       GM_notification
// @grant       GM_xmlhttpRequest
// @homepageURL https://github.com/HimbeersaftLP/libgif-js/
// ==/UserScript==
!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){var r,o,i;o=[],void 0===(i="function"==typeof(r=function(){var e=function(e){return e.reduce((function(e,t){return 2*e+t}),0)},t=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},n=function(e){this.data=e,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[this.pos++]:255&e.charCodeAt(this.pos++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},r=function(n,r){r||(r={});var o=function(e){for(var t=[],r=0;r<e;r++)t.push(n.readBytes(3));return t},i=function(){var e,t;t="";do{e=n.readByte(),t+=n.read(e)}while(0!==e);return t},a=function(a){a.leftPos=n.readUnsigned(),a.topPos=n.readUnsigned(),a.width=n.readUnsigned(),a.height=n.readUnsigned();var s=t(n.readByte());a.lctFlag=s.shift(),a.interlaced=s.shift(),a.sorted=s.shift(),a.reserved=s.splice(0,2),a.lctSize=e(s.splice(0,3)),a.lctFlag&&(a.lct=o(1<<a.lctSize+1)),a.lzwMinCodeSize=n.readByte();var c=i();a.pixels=function(e,t){for(var n,r,o=0,i=function(e){for(var n=0,r=0;r<e;r++)t.charCodeAt(o>>3)&1<<(7&o)&&(n|=1<<r),o++;return n},a=[],s=1<<e,c=s+1,l=e+1,u=[],d=function(){u=[],l=e+1;for(var t=0;t<s;t++)u[t]=[t];u[s]=[],u[c]=null};;)if(r=n,(n=i(l))!==s){if(n===c)break;if(n<u.length)r!==s&&u.push(u[r].concat(u[n][0]));else{if(n!==u.length)throw new Error("Invalid LZW code.");u.push(u[r].concat(u[r][0]))}a.push.apply(a,u[n]),u.length===1<<l&&l<12&&l++}else d();return a}(a.lzwMinCodeSize,c),a.interlaced&&(a.pixels=function(e,t){for(var n=new Array(e.length),r=e.length/t,o=function(r,o){var i=e.slice(o*t,(o+1)*t);n.splice.apply(n,[r*t,t].concat(i))},i=[0,4,2,1],a=[8,8,4,2],s=0,c=0;c<4;c++)for(var l=i[c];l<r;l+=a[c])o(l,s),s++;return n}(a.pixels,a.width)),r.img&&r.img(a)},s=function(){var o={};switch(o.sentinel=n.readByte(),String.fromCharCode(o.sentinel)){case"!":o.type="ext",function(o){switch(o.label=n.readByte(),o.label){case 249:o.extType="gce",function(o){n.readByte();var i=t(n.readByte());o.reserved=i.splice(0,3),o.disposalMethod=e(i.splice(0,3)),o.userInput=i.shift(),o.transparencyGiven=i.shift(),o.delayTime=n.readUnsigned(),o.transparencyIndex=n.readByte(),o.terminator=n.readByte(),r.gce&&r.gce(o)}(o);break;case 254:o.extType="com",function(e){e.comment=i(),r.com&&r.com(e)}(o);break;case 1:o.extType="pte",function(e){n.readByte(),e.ptHeader=n.readBytes(12),e.ptData=i(),r.pte&&r.pte(e)}(o);break;case 255:o.extType="app",function(e){switch(n.readByte(),e.identifier=n.read(8),e.authCode=n.read(3),e.identifier){case"NETSCAPE":!function(e){n.readByte(),e.unknown=n.readByte(),e.iterations=n.readUnsigned(),e.terminator=n.readByte(),r.app&&r.app.NETSCAPE&&r.app.NETSCAPE(e)}(e);break;default:!function(e){e.appData=i(),r.app&&r.app[e.identifier]&&r.app[e.identifier](e)}(e)}}(o);break;default:o.extType="unknown",function(e){e.data=i(),r.unknown&&r.unknown(e)}(o)}}(o);break;case",":o.type="img",a(o);break;case";":o.type="eof",r.eof&&r.eof(o);break;default:throw new Error("Unknown block: 0x"+o.sentinel.toString(16))}"eof"!==o.type&&setTimeout(s,0)};!function(){var i={};if(i.sig=n.read(3),i.ver=n.read(3),"GIF"!==i.sig)throw new Error("Not a GIF file.");i.width=n.readUnsigned(),i.height=n.readUnsigned();var a=t(n.readByte());i.gctFlag=a.shift(),i.colorRes=e(a.splice(0,3)),i.sorted=a.shift(),i.gctSize=e(a.splice(0,3)),i.bgColor=n.readByte(),i.pixelAspectRatio=n.readByte(),i.gctFlag&&(i.gct=o(1<<i.gctSize+1)),r.hdr&&r.hdr(i)}(),setTimeout(s,0)};return function(e){var t,o,i={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var a in e)i[a]=e[a];i.vp_w&&i.vp_h&&(i.is_vp=!0);var s,c=null,l=!1,u=null,d=null,p=null,f=null,h=null,g=null,m=null,y=!0,v=!1,_=[],w=[],b=1,x=i.gif;void 0===i.auto_play&&(i.auto_play=!x.getAttribute("rel:auto_play")||"1"==x.getAttribute("rel:auto_play"));var C,E,T,P,S=i.hasOwnProperty("on_end")?i.on_end:null,j=i.hasOwnProperty("loop_delay")?i.loop_delay:0,k=i.hasOwnProperty("loop_mode")?i.loop_mode:"auto",B=!i.hasOwnProperty("draw_while_loading")||i.draw_while_loading,A=!!B&&(!i.hasOwnProperty("show_progress_bar")||i.show_progress_bar),M=i.hasOwnProperty("progressbar_height")?i.progressbar_height:25,O=i.hasOwnProperty("progressbar_background_color")?i.progressbar_background_color:"rgba(255,255,255,0.4)",R=i.hasOwnProperty("progressbar_foreground_color")?i.progressbar_foreground_color:"rgba(255,0,22,.8)",U=function(){u=null,d=null,h=p,p=null,g=null},I=function(){try{r(t,q)}catch(e){D("parse")}},L=function(e,t){C.width=e*J(),C.height=t*J(),T.style.minWidth=e*J()+"px",P.width=e,P.height=t,P.style.width=e+"px",P.style.height=t+"px",P.getContext("2d").setTransform(1,0,0,1,0,0)},N=function(e,t,n){if(n&&A){var r,o,a,s=M;i.is_vp?v?(o=(i.vp_t+i.vp_h-s)/J(),s/=J(),r=i.vp_l/J()+e/t*(i.vp_w/J()),a=C.width/J()):(o=i.vp_t+i.vp_h-s,s=s,r=i.vp_l+e/t*i.vp_w,a=C.width):(o=(C.height-s)/(v?J():1),r=e/t*C.width/(v?J():1),a=C.width/(v?J():1),s/=v?J():1),E.fillStyle=O,E.fillRect(r,o,a-r,s),E.fillStyle=R,E.fillRect(0,o,r,s)}},D=function(e){c=e,o={width:x.width,height:x.height},_=[],E.fillStyle="black",E.fillRect(0,0,i.c_w?i.c_w:o.width,i.c_h?i.c_h:o.height),E.strokeStyle="red",E.lineWidth=3,E.moveTo(0,0),E.lineTo(i.c_w?i.c_w:o.width,i.c_h?i.c_h:o.height),E.moveTo(0,i.c_h?i.c_h:o.height),E.lineTo(i.c_w?i.c_w:o.width,0),E.stroke()},G=function(){g&&(_.push({data:g.getImageData(0,0,o.width,o.height),delay:d}),w.push({x:0,y:0}))},W=function(){var e,t,n,r=-1,o=0,a=function(e){r+=e,u()},l=(e=!1,t=function(){null!==S&&S(x),o++,!1!==k||o<0?n():(e=!1,y=!1)},n=function(){if(e=y){a(1);var o=10*_[r].delay;o||(o=100),o*=b,0==(r+1+_.length)%_.length?(o+=j,setTimeout(t,o)):setTimeout(n,o)}},function(){e||setTimeout(n,0)}),u=function(){var e;s&&s(r),(r=parseInt(r,10))>_.length-1&&(r=0),r<0&&(r=0),e=w[r],P.getContext("2d").putImageData(_[r].data,e.x,e.y),E.globalCompositeOperation="copy",E.drawImage(P,0,0)};return{init:function(){c||(i.c_w&&i.c_h||E.scale(J(),J()),i.auto_play?l():(r=0,u()))},step:l,play:function(){y=!0,l()},pause:function(){y=!1},playing:y,move_relative:a,current_frame:function(){return r},length:function(){return _.length},move_to:function(e){r=e,u()}}}(),z=function(e){N(t.pos,t.data.length,e)},F=function(){},H=function(e,t){return function(n){e(n),z(t)}},q={hdr:H((function(e){L((o=e).width,o.height)})),gce:H((function(e){G(),U(),u=e.transparencyGiven?e.transparencyIndex:null,d=e.delayTime,p=e.disposalMethod})),com:H(F),app:{NETSCAPE:H(F)},img:H((function(e){g||(g=P.getContext("2d"));var t=_.length,n=e.lctFlag?e.lct:o.gct;t>0&&(3===h?null!==f?g.putImageData(_[f].data,0,0):g.clearRect(m.leftPos,m.topPos,m.width,m.height):f=t-1,2===h&&g.clearRect(m.leftPos,m.topPos,m.width,m.height));var r=g.getImageData(e.leftPos,e.topPos,e.width,e.height);e.pixels.forEach((function(e,t){e!==u&&(r.data[4*t+0]=n[e][0],r.data[4*t+1]=n[e][1],r.data[4*t+2]=n[e][2],r.data[4*t+3]=255)})),g.putImageData(r,e.leftPos,e.topPos),v||(E.scale(J(),J()),v=!0),B&&(E.drawImage(P,0,0),B=i.auto_play),m=e}),!0),eof:function(){G(),z(!1),i.c_w&&i.c_h||(C.width=o.width*J(),C.height=o.height*J()),W.init(),l=!1,Z&&Z(x)}},X=function(){var e=x.parentNode,t=document.createElement("div");C=document.createElement("canvas"),E=C.getContext("2d"),T=document.createElement("div"),P=document.createElement("canvas"),t.width=C.width=x.width,t.height=C.height=x.height,T.style.minWidth=x.width+"px",t.className="jsgif",T.className="jsgif_toolbar",t.appendChild(C),t.appendChild(T),e.insertBefore(t,x),e.removeChild(x),i.c_w&&i.c_h&&L(i.c_w,i.c_h),V=!0},J=function(){return i.max_width&&o&&o.width>i.max_width?i.max_width/o.width:1},V=!1,Z=!1,$=function(e){return!l&&(Z=e||!1,l=!0,_=[],U(),f=null,h=null,g=null,m=null,!0)};return{play:W.play,pause:W.pause,move_relative:W.move_relative,move_to:W.move_to,get_playing:function(){return y},get_canvas:function(){return C},get_canvas_scale:function(){return J()},get_loading:function(){return l},get_auto_play:function(){return i.auto_play},get_length:function(){return W.length()},get_current_frame:function(){return W.current_frame()},load_url:function(e,r,o){if($(r)){var i=new XMLHttpRequest;i.open("GET",e,!0),"overrideMimeType"in i?i.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in i?i.responseType="arraybuffer":i.setRequestHeader("Accept-Charset","x-user-defined"),i.onloadstart=function(){V||X()},i.onload=function(){200!=this.status&&D("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var e=this.response;e.toString().indexOf("ArrayBuffer")>0&&(e=new Uint8Array(e)),t=new n(e),setTimeout(I,0)},i.onprogress=function(e){e.lengthComputable&&N(e.loaded,e.total,!0)},i.onerror=function(e){l=!1,o(e)},i.send()}},load:function(e,t){this.load_url(x.src,e,t)},load_raw:function(e,r){$(r)&&(V||X(),t=new n(e),setTimeout(I,0))},set_frame_offset:function(e,t){w[e]?(void 0!==t.x&&(w[e].x=t.x),void 0!==t.y&&(w[e].y=t.y)):w[e]=t},set_multiplier:function(e){b=e},on_frame_change:function(e){s=e}}}})?r.apply(t,o):r)||(e.exports=i)},function(e,t,n){var r=n(3);e.exports="string"==typeof r?r:r.toString()},function(e,t,n){"use strict";n.r(t);var r=n(0),o=n.n(r),i=n(1),a=n.n(i);!function(){let e=!1;function t(t){const n=new o.a({gif:t,auto_play:!0});function r(){const t=n.get_canvas().parentElement.querySelector(".jsgif_toolbar");t.style.setProperty("font-family","sans-serif","important"),t.style.maxWidth=t.style.minWidth,t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation()});const r=document.createElement("div");r.className="jsgif-userscript-pbar",t.appendChild(r);const o=n.get_length()-1;n.on_frame_change(e=>{e===o+1&&(e=0);const t=Math.round(e/o*100)+"%";r.textContent=e+"/"+o+" ("+t+")",r.style.setProperty("background-image","linear-gradient(90deg, gray "+t+", #eee "+t+", #eee 100%)","important")});let i=!1;function s(e){const t=r.getBoundingClientRect(),i=e.clientX-t.x,a=Math.round(i/t.width*o);n.move_to(a)}r.addEventListener("mousedown",e=>{i=!0,s(e)}),r.addEventListener("mousemove",e=>{i&&s(e)}),window.addEventListener("mouseup",()=>i=!1);const c=document.createElement("div");function l(e,t){const n=document.createElement("button");return n.className="jsgif-userscript-btn",n.textContent=e,n.addEventListener("click",t),c.appendChild(n),n}c.className="jsgif-userscript-btn-container",t.appendChild(c),l("⏸",e=>{n.get_playing()?(e.target.innerHTML="▶",n.pause()):(e.target.innerHTML="⏸",n.play())}),l("⬅",()=>{n.get_current_frame()<=0?n.move_to(o):n.move_relative(-1)}),l("➡",()=>{n.get_current_frame()>=o?n.move_to(0):n.move_relative(1)}),l("⏹",()=>{n.pause(),n.move_to(0)});const u=document.createElement("select");[.25,.5,1,1.5,2].forEach(e=>{const t=document.createElement("option");t.textContent="x"+e,t.value=e,1===e&&(t.selected=!0),u.appendChild(t)}),u.addEventListener("input",()=>{n.set_multiplier(1/u.value)}),c.appendChild(u),function(){if(e)return;e=!0;const t=document.createElement("style");t.textContent=a.a,document.head.appendChild(t)}()}n.load(r,e=>{GM_xmlhttpRequest({url:t.src,method:"GET",overrideMimeType:"text/plain; charset=x-user-defined",anonymous:!0,onload:e=>{200===e.status&&(unsafeWindow.gifData=e.response,n.load_raw(e.response,r))},onerror:()=>{GM_notification({title:"jsgif can't load this image",text:"Reason: Unknown XHR error."})}})})}GM_registerMenuCommand("Add Controls",(function(){const e=document.querySelectorAll('img[src$=".gif"]');e.length>0&&Array.from(e).forEach(e=>{if(null!==e.getAttribute("data-jsgif-listeneradded"))return;let n;e.setAttribute("data-jsgif-listeneradded",""),e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),e.complete&&void 0!==e.naturalWidth&&0!==e.naturalWidth?t(e):e.onload=()=>t(e)}),e.addEventListener("mouseover",()=>{n=e.style.filter,e.style.filter=n+"brightness(0.3)"}),e.addEventListener("mouseout",()=>e.style.filter=n)})}))}()},function(e,t,n){(t=n(4)(!1)).push([e.i,'.jsgif_toolbar {\r\n    display: none;\r\n    position: absolute;\r\n    left: 0;\r\n    bottom: 0;\r\n    background-color: rgba(0, 0, 0, 0.7);\r\n}\r\n\r\n.jsgif:hover > .jsgif_toolbar {\r\n    display: block;\r\n}\r\n\r\n.jsgif-userscript-pbar {\r\n    color: #000 !important;\r\n    background-color: #eee !important;\r\n    text-decoration: none !important;\r\n    line-height: normal !important;\r\n    cursor: default !important;\r\n    user-select: none !important;\r\n    text-align: center !important;\r\n}\r\n\r\n.jsgif-userscript-btn-container {\r\n    display: flex;\r\n    justify-content: center;\r\n}\r\n\r\n.jsgif-userscript-btn {\r\n    font-family: "Segoe UI Symbol", sans-serif !important;\r\n    height: 30px !important;\r\n    width: 30px !important;\r\n}',""]),e.exports=t},function(e,t,n){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=function(e,t){var n=e[1]||"",r=e[3];if(!r)return n;if(t&&"function"==typeof btoa){var o=(a=r,s=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),"/*# ".concat(c," */")),i=r.sources.map((function(e){return"/*# sourceURL=".concat(r.sourceRoot||"").concat(e," */")}));return[n].concat(i).concat([o]).join("\n")}var a,s,c;return[n].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(n,"}"):n})).join("")},t.i=function(e,n,r){"string"==typeof e&&(e=[[null,e,""]]);var o={};if(r)for(var i=0;i<this.length;i++){var a=this[i][0];null!=a&&(o[a]=!0)}for(var s=0;s<e.length;s++){var c=[].concat(e[s]);r&&o[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),t.push(c))}},t}}]);